#!/bin/sh

SSH_KEY=/opt/codenvy-data/conf/ssh/key.pem
SSH_USER=user

SRC_FOLDER=${1}
SRC_HOST=${2}
SRC_PORT=${3}
DST_FOLDER=${4}
REMOVE_ON_SUCCESS=${5=false}

# ensure existing trailing slash to overrite permissions of destination folder too
#if [[ ${SRC_FOLDER} != */ ]]; then
   SRC_FOLDER=${SRC_FOLDER}"/"
#fi
#if [[ ${DST_FOLDER} != */ ]]; then
   DST_FOLDER=${DST_FOLDER}"/"
#fi

rsync --quiet --delete --partial --links --safe-links --recursive --times --human-readable --bwlimit=7000 --executability \
              --port=${SRC_PORT} \
              --include='.codenvy/' \
              --filter=':- .gitignore' \
              --rsh="ssh -i ${SSH_KEY} -l ${SSH_USER} -o StrictHostKeyChecking=no -p ${SRC_PORT}" \
              --rsync-path="sudo rsync" \
              ${SRC_HOST}:${SRC_FOLDER} ${DST_FOLDER}

if [[ ${REMOVE_ON_SUCCESS} == true ]]; then
   ssh -i ${SSH_KEY} ${SSH_USER}@${SRC_HOST} "sudo rm -rf ${SRC_FOLDER}"
fi

#echo "Doing backup"
